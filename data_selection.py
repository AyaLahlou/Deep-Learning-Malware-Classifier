import os
import csv
from random import sample
import shutil
import pickle
from shutil import copyfile
import pandas as pd
import config


def wanna_split(virusdata):
    notwanna=[]
    wanna=[]
    for i in range(len(virusdata)):
        try:
            if virusdata.loc[i]['virus_type']=='wanna':
                wanna.append(virusdata.loc[i]['filename'])
            else:
                notwanna.append(virusdata.loc[i]['filename'])
        except Exception as e:
            pass
    print(wanna)
    return notwanna, wanna



def get_benign(datadir, dst,size):

    files = os.listdir(datadir)
    n=0
    with open('example.csv', 'w') as csvFile:
        writer =csv.writer(csvFile)

        for i in files:
            src = os.path.join(datadir, i)
            dsti=os.path.join(dst, i)
            st= os.stat(src)
            if st.st_size<6000000:
                n+=1
                copyfile(src,dsti)
                writer.writerows([[i,'0']])
                if n==size:
                    break

    csvFile.close()


def get_malware(datadir, dst, size, wanna , notwanna):
    wannasize = round(0.25*size)

    def get_wanna(wanna):
        with open('example.csv', 'a') as csvFile:
            writer = csv.writer(csvFile)
            for i in sample(wanna,wannasize):
                src=os.path.join(datadir,i)
                desti=os.path.join(dst,i)
                st=os.stat(src)
                if st.st_size<6000000:
                    copyfile(src,desti)
                    writer.writerows([[i,'1']])

        csvFile.close()

    def get_notwanna(notwanna):
        n=0
        with open('example.csv', 'a') as csvFile:
            writer = csv.writer(csvFile)
            for i in sample(notwanna,len(notwanna)) :
                try:
                    src = os.path.join(datadir, i)
                    desti = os.path.join(dst, i)
                    st=os.stat(src)
                    if st.st_size < 6000000:
                        copyfile(src, desti)
                        n+=1
                        writer.writerows([[i, '1']])
                    if n==round(0.75*size):
                        break
                except Exception as e:
                    pass

        csvFile.close()
    get_wanna(wanna)
    get_notwanna(notwanna)


if __name__ == '__main__':
    virusdata=pd.read_csv(config.path['malware_csv'])
    notwanna,wanna=wanna_split(virusdata)
    get_benign(config.path['benign_folder'], config.path['main_dir'], 2500)
    get_malware(config.path['malware_folder'],config.path['main_dir'],2500, wanna , notwanna)
